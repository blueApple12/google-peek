<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Reveal</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --text: #a6ff9e;
      --muted: #64c661;
      --dim: #2a2f2a;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f5fff5;
        --text: #0a4f0a;
        --muted: #1e7a1e;
        --dim: #dbeadb;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 0 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
      direction: rtl; /* you can change to ltr if you prefer */
    }
    .screen {
      width: min(92vw, 900px);
      min-height: 40vh;
      border: 2px solid var(--dim);
      border-radius: 10px;
      padding: clamp(16px, 4vw, 28px);
      background:
        radial-gradient(ellipse at center, rgba(255,255,255,0.04), transparent 70%),
        linear-gradient(transparent 23px, rgba(0,0,0,0.2) 24px) repeat-y;
      background-size: 100% 100%, 100% 24px; /* faint scanlines */
      box-shadow: 0 12px 40px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,0.03);
    }
    .label {
      color: var(--muted);
      font-size: clamp(14px, 2.8vw, 18px);
      margin-bottom: 8px;
    }
    .value {
      font-size: clamp(22px, 6vw, 44px);
      font-weight: 700;
      word-break: break-word;
      line-height: 1.15;
    }
    .value[dir="auto"] { unicode-bidi: plaintext; }
    .hint {
      margin-top: 10px;
      color: var(--muted);
      font-size: clamp(12px, 2.5vw, 14px);
    }
    .meta {
      margin-top: 6px;
      color: var(--muted);
      font-size: clamp(11px, 2.3vw, 13px);
      opacity: .8;
    }
    .cursor {
      display: inline-block;
      width: .6ch; height: 1em;
      background: var(--text);
      margin-inline-start: .2ch;
      animation: blink 1s steps(1,end) infinite;
      vertical-align: -0.1em;
    }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="screen" role="status" aria-live="polite">
    <div class="label">את/ה תחפש/י:</div>
    <div id="qValue" class="value" dir="auto">טוען…<span class="cursor"></span></div>
    <div id="hint" class="hint">ממתין לחיפוש…</div>
    <div id="meta" class="meta"></div>
  </div>

  <script>
    // READ from the non-redirect endpoint (your working JSON URL)
    const ENDPOINT_READ =
      'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLj4pZ-ObGA5shnEwC4QRRNV8ql48vUDuggY2fKuk6MUkaB3gIc7KpMshaNeiggPluFFMM-0wzZGGFibaO9dHNKQG06PSYefruK1csCRjrPbtUxQzhf2MQo27zjzUHpy71qJpL4plo4OpH-SIAtsfeETNoTVC7UMd4pqUcyteEp_CbdN9GOEP_VUgXVgijcynkvgW7rACn_G25MDKg0cA8PyyT5nFsFEggBnDY5KnV9aI62b5oK-IiZambGkVT0W0zN6YzpYsjNUrCbWwMuigXCiPeaGh-ShwxnLuUQN3LRIvU8d0sSETv8zFQXjFNx_YBysgVW1&lib=MzzrTQlrfnN0tvGhuSjlcrSJ3hd7ZTgdh';

    // If your script checks a key, keep it here; it’ll be passed through to the echo URL too
    const API_KEY = 'magic-key-2025';

    const POLL_MS = 2000;      // poll every 2s
    const MAX_BACKOFF = 15000; // max backoff on repeated failures

    const qEl   = document.getElementById('qValue');
    const hint  = document.getElementById('hint');
    const meta  = document.getElementById('meta');

    function tsToLocal(ts){
      try { return new Date(Number(ts)).toLocaleString(); } catch { return ''; }
    }

    // Robust parser: works if response is pure JSON or HTML wrapping <pre>{...}</pre>
    function extractData(text){
      // try parse as JSON straight
      try {
        const obj = JSON.parse(text);
        if (obj && typeof obj.q === 'string') return obj;
      } catch (_) {}

      // else, try to pull JSON out of <pre>...</pre>
      const match = text.match(/<pre>\s*({[\s\S]*?})\s*<\/pre>/i);
      if (match) {
        try {
          const obj = JSON.parse(match[1]);
          if (obj && typeof obj.q === 'string') return obj;
        } catch (_) {}
      }
      return null;
    }

    async function fetchLatest(){
      const url = ENDPOINT_READ + '&latest=1&key=' + encodeURIComponent(API_KEY) + '&_=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      const text = await res.text(); // handle text/plain or HTML
      if (!res.ok) throw new Error('HTTP ' + res.status + ' ' + text.slice(0,120));
      const data = extractData(text);
      if (!data) throw new Error('No JSON found');
      return data; // { q, ts }
    }

    let lastQ = null;

    (async function pollLoop(){
      let backoff = POLL_MS;
      while (true) {
        try {
          const data = await fetchLatest();
          if (data && typeof data.q === 'string') {
            const q = data.q.trim();
            if (q && q !== lastQ) {
              lastQ = q;
              qEl.textContent = q;
              qEl.setAttribute('dir','auto'); // handles RTL/LTR automatically
              hint.textContent = '';
              meta.textContent = 'עודכן: ' + tsToLocal(data.ts || Date.now());
            }
          }
          backoff = POLL_MS;
        } catch (err) {
          hint.textContent = 'ממתין לחיפוש…';
          backoff = Math.min(Math.ceil(backoff * 1.8), MAX_BACKOFF);
        }
        await new Promise(r => setTimeout(r, backoff));
      }
    })();
  </script>
</body>
</html>
